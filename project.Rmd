---
title: "week5-ex"
output: html_document
---

```{r setup, include=FALSE}
library(readr)
library(sf)
library(terra)
library(dplyr)
library(lubridate)
library(ggplot2)
library(tmap)
library(sp)
library(devtools)
library(som)
#install.packages("trajr")
library(trajr)

#install.packages("devtools")

library(ComputationalMovementAnalysisData)

devtools::install_github("ComputationalMovementAnalysis/ComputationalMovementAnalysisData")

```


# show data
```{r cars}
head(wildschwein_BE)
head(wildschwein_metadata)
head(wildschwein_overlap_temp)
head(schreck_agenda)
head(schreck_locations)
```

# Schreck prepare
```{r }
schreck_locations_ch <- schreck_locations %>% st_as_sf(coords = c("lon", "lat"), crs = CRS("+init=epsg:4326"), remove = FALSE)  #%>% st_transform(crs = 2056)
schreck_locations_ch <- schreck_locations_ch %>% st_transform(crs = 2056)
schreck_locations_ch <- schreck_locations_ch %>% filter(lat < 47.2 & lon < 7.5)
coordsne <- unlist(st_geometry(schreck_locations_ch)) %>% matrix(ncol=2,byrow=TRUE) %>% as_tibble() %>% setNames(c("N","E"))
schreck_locations_ch$N <- coordsne$E
schreck_locations_ch$E <- coordsne$N
#join 
schreck_locations_ch <- schreck_locations_ch %>% left_join(schreck_agenda, by=c("id"="id"))
schreck_locations_ch$wid <- c(1:25)
schreck_locations_ch <- schreck_locations_ch %>% mutate(wid=as.character(wid))
```

# Get common data, show examples
```{r }
# Get common samples
head(wildschwein_BE)
head(schreck_locations_ch)
sabi <- wildschwein_BE %>% filter(TierName=="Sabine")
# Filter night data
sabi <- sabi %>% filter(day != "Tag" & !is.na(day)) # only night gps

s1 <- schreck_locations_ch[5,]
sabi <- sabi %>% filter(DatetimeUTC > first(s1$datum_on) & DatetimeUTC < first(s1$datum_off))
sabi <- sabi %>% mutate(dist = sqrt((first(s1$N)-N)^2+(first(s1$E)-E)^2))
sabi <- sabi %>% filter(dist < 400)
sabi <- sabi %>% mutate(trip = ifelse(hour(DatetimeUTC) > 16, day(DatetimeUTC)+1, day(DatetimeUTC)))


ggplot() +
  geom_path(data=sabi %>%  filter(trip<11), aes(x=E, y=N, color=factor(trip))) +
  geom_point(data = s1, aes(x=E, y=N), colour="black", size=2) 

# Get example 1
wildboar_closeup <- wildschwein_BE %>% 
  filter(TierName=="Sabine" & DatetimeUTC > as_datetime('2015-06-09 22:30:43') & DatetimeUTC < as_datetime('2015-06-10 14:30:43')) %>% 
  mutate(dist = sqrt((first(s1$N)-N)^2+(first(s1$E)-E)^2)) %>% mutate(triptime0 = as.numeric((DatetimeUTC - min(DatetimeUTC))) / 60)
ggplot() +
  geom_path(data=wildboar_closeup, aes(x=E, y=N, color=triptime0)) +
  geom_point(data = s1, aes(x=E, y=N), colour="black", size=2) 
# Get example 2
wildboar_closeup1 <- wildschwein_BE %>% 
  filter(TierName=="Sabine" & DatetimeUTC > as_datetime('2015-06-08 18:30:43') & DatetimeUTC < as_datetime('2015-06-09 14:30:43')) %>% 
  mutate(dist = sqrt((first(s1$N)-N)^2+(first(s1$E)-E)^2)) %>% mutate(triptime0 = as.numeric((DatetimeUTC - min(DatetimeUTC))) / 60) %>% arrange(.,triptime0)
ggplot() +
  geom_path(data=wildboar_closeup1, aes(x=E, y=N, color=triptime0)) +
  geom_point(data = s1, aes(x=E, y=N), colour="black", size=2) 
# Get example 2
wildboar_closeup2 <- wildschwein_BE %>% 
  filter(TierName=="Sabine" & DatetimeUTC > as_datetime('2015-06-07 18:30:43') & DatetimeUTC < as_datetime('2015-06-08 14:30:43')) %>% 
  mutate(dist = sqrt((first(s1$N)-N)^2+(first(s1$E)-E)^2)) %>% mutate(triptime0 = as.numeric((DatetimeUTC - min(DatetimeUTC))) / 60) %>% arrange(.,triptime0)
ggplot() +
  geom_path(data=wildboar_closeup2, aes(x=E, y=N, color=triptime0)) +
  geom_point(data = s1, aes(x=E, y=N), colour="black", size=2) 

# Plot
head(schreck_locations_ch)
ggplot() +
  geom_sf(data = schreck_locations_ch, color='black') +
  geom_sf(data=wildschwein_BE %>% filter(TierName=="Sabi"), color="blue")

ggplot() +
  geom_point(data = schreck_locations_ch, aes(x=E, y=N, color='red')) +
  geom_point(data=sabi, aes(x=E, y=N,color="blue")) + ylim(1200000, 1210000) +  xlim(2568000, 2578000)
sabi %>% filter(day==10)



```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

# Adding closest active schreck (+ distance) to each observation
```{r }
### data
w<-wildschwein_BE %>% mutate(date = as.Date(DatetimeUTC), 
                             time= format(DatetimeUTC, format = "%H:%M:%S"),
                             hour= as.integer(format(DatetimeUTC, format = "%H"))+
                               as.integer(format(DatetimeUTC, format = "%M"))/60)
sl<-schreck_locations

###
s<-data.frame(schreck_locations_ch) ## I had to transform it to a data frame, otherwise something was weird about the coordinates (geometry)
###

s1<-s[!duplicated(s$id),c("id","N","E")] # list with all Schrecks and their location

# Set id to w
w <- w %>% mutate(id = row_number())

## reduce data to certain time frame
w1<-w %>% 
  filter (day!="Tag"&!is.na(day) &
            ((DatetimeUTC > as.Date("2014-05-01") & DatetimeUTC < as.Date("2014-07-04")) | 
                (DatetimeUTC > as.Date("2015-05-20") & DatetimeUTC < as.Date("2015-07-01")) |
                 (DatetimeUTC > as.Date("2016-04-04") & DatetimeUTC < as.Date("2016-10-04")) |
                 (DatetimeUTC > as.Date("2017-04-26") & DatetimeUTC < as.Date("2017-11-18"))))
nrow(w1)


#for(j in 1:nrow(w1)){
### look only at Schrecks that were active on that day
 # s_on<-s[s$datum_on < w1[j,]$DatetimeUTC & s$datum_off > w1[j,]$DatetimeUTC,]
  #if(nrow(s_on)==0)
   # {w1[j,"closest_schreck"]<-"no_Schreck_on"}  
  #else{     
    #for(i in 1:nrow(s_on)){ ## calculate difference between current observation (j) and each schreck location
      #s_on[i,"diff"]<-sqrt((w1[j,"N"]-s_on[i,"N"])^2+(w1[j,"E"]-s_on[i,"E"])^2)} ## add difference of current observation to location into file
#### look at the distance of the closest Schreck, only use it if less than 400m
  #if(min(s_on$diff)>400){
      #w1[j,"closest_schreck"]<-"no_Schreck_witin_400m"} 
  #else{
      #w1[j,"closest_schreck"]<-s_on[s_on$diff==min(s_on$diff),"id"]  ## add closest schreck to each wild boar location
      #w1[j,"distance_to_closest_schreck"]<-s_on[s_on$diff==min(s_on$diff),"diff"]
#}}}

# Save data.frame to spare time
#write.csv(w1, "wildboar_loop.csv")

w1 <- read_delim("wildboar_loop.csv",",")
w1 <- w1 %>% mutate(hour= as.integer(format(DatetimeUTC, format = "%H")),
                tripdate= ifelse(hour < 12, as.Date(DatetimeUTC)-1, as.Date(DatetimeUTC)),
                tripdate2 = as.Date(tripdate, origin="1970-01-01"))

# Merge close wildschweinschreck gps  data to origin wildboar
w <- w %>% left_join(w1 %>% dplyr::select(id, closest_schreck, distance_to_closest_schreck), by="id")
w <- w %>% mutate(closest_schreck= 
  ifelse(is.na(closest_schreck), "no_Schreck_witin_400m", closest_schreck))

#add tripdate
w <- w %>% mutate(hour= as.integer(format(DatetimeUTC, format = "%H")),
                tripdate= ifelse(hour < 12, as.Date(DatetimeUTC)-1, as.Date(DatetimeUTC)),
                tripdate2 = as.Date(tripdate, origin="1970-01-01"))


w %>% dplyr::select(DatetimeUTC, tripdate2)
```

# Separation of the wildboar trips
```{r }

# split time and day in separate columns:
w1$Date <- as.Date(w1$DatetimeUTC)
## order data frame by animal and time
w1<-w1[order(w1$TierName) & order(w1$DatetimeUTC),]


##### Create trips: with shorest distance to schreck (for each tripdate) ########################################

# split time and day in separate columns:
w1$Date <- as.Date(w1$DatetimeUTC)

## order data frame by animal and time
w1<-w1[order(w1$TierName) & order(w1$DatetimeUTC),]

## empty column for trip id
w$tripID_dist<-"NA"
w$start_dist<-"no"
w$isNearestPoint <- "no"
animals<-unique(w1$TierName)

for(j in 1:length(animals)){
  days<-unique(w1[w1$TierName==animals[j] & !is.na(w1$TierName),]$tripdate2) 
  if(length(days)!=0){
    for(i in 1:length(days)){
      n<-w1[w1$TierName==animals[j] & w1$tripdate2==days[i],]
      if(nrow(n[!is.na(n$distance_to_closest_schreck),])==0){nmin<-NA} else{
      nmin<-min(n$distance_to_closest_schreck,na.rm=T)}
      if(!is.na(nmin)){ ## only continue if nmin is not NA
        if(nmin<=400){ ## only continue if minimal distance to schreck is less than 400m
      n<-n[n$distance_to_closest_schreck==nmin & !is.na(n$distance_to_closest_schreck),]
      w[w$TierName==animals[j] & w$DatetimeUTC == n$DatetimeUTC, "isNearestPoint"] <- "yes"
        w[w$TierName==animals[j] & (w$DatetimeUTC >= n$DatetimeUTC-4*60*60) & (w$DatetimeUTC <= n$DatetimeUTC+4*60*60),"tripID_dist"]<-paste(animals[j],i, sep="_")                               
        w[w$TierName==animals[j] & w$DatetimeUTC==n$DatetimeUTC,"start_dist"]<-"yes"
      }}}}}

# Only trips in the night
w <- w %>% group_by(TierID, tripdate2) %>% mutate(isTrip= max(tripID_dist) != 'NA',
                                          tripIDnight = ifelse((hour < 9.1 | hour >= 17.9)&isTrip,
                                                              max(tripID_dist), NA)) %>% ungroup()


# length(unique(w$tripIDnight)); table(w[!is.na(w$tripIDnight),]$isNearestPoint)

#List with closest_distance to schreck for each trip
trip_list <- w %>% 
  filter (isNearestPoint=="yes" & !is.na (tripIDnight))

nrow(trip_list)

head(data.frame(trip_list))
```

# Wildschewinschreck
```{r}

# Determine mean speaker orientation
schreck_locations_ch <- schreck_locations_ch %>% 
  mutate(ausrichtung_mean = (ausrichtung_max - ausrichtung_min) / 2 +ausrichtung_min,
         ausrichtung_dir = ifelse(ausrichtung_mean >= 45 & ausrichtung_mean < 135, "E", 
                                  ifelse(ausrichtung_mean > 135 & ausrichtung_mean < 225, "S",
                                         ifelse(ausrichtung_mean > 225 & ausrichtung_mean < 315, "W", "N")))) 


s1 <- schreck_locations_ch[5,]

wildboar_closeup <- wildschwein_BE %>% 
  filter(TierName=="Sabine" & DatetimeUTC > as_datetime('2015-06-08 18:30:43') & DatetimeUTC < as_datetime('2015-06-09 10:30:43')) %>% 
  mutate(dist = sqrt((first(s1$N)-N)^2+(first(s1$E)-E)^2)) %>% mutate(triptime0 = as.numeric((DatetimeUTC - min(DatetimeUTC))) / 60) %>% arrange(.,triptime0)

schreck_orientation <- s1 %>% mutate(length=lautstaerke*lautstaerke/100)
rad2deg <- function(rad) {(rad * 180) / (pi)}
deg2rad <- function(deg) {(deg * pi) / (180)}

schreck_orientation$asurichtung_mean <- (schreck_orientation$ausrichtung_max-
                                           schreck_orientation$ausrichtung_min) / 2 +
                                        schreck_orientation$ausrichtung_min
schreck_orientation$ausrichung_meanE = schreck_orientation$E[1] + schreck_orientation$length[1] * 2*
  cos(deg2rad(360-270-(schreck_orientation$asurichtung_mean[1])))
schreck_orientation$ausrichung_meanN = schreck_orientation$N[1] + schreck_orientation$length[1] *2* 
  sin(deg2rad(360-270-(schreck_orientation$asurichtung_mean[1])))

schreck_orientation$ausrichung_minE = schreck_orientation$E[1] + schreck_orientation$length[1] * 
  cos(deg2rad(360-270-schreck_orientation$ausrichtung_min[1]))
schreck_orientation$ausrichung_minN = schreck_orientation$N[1] + schreck_orientation$length[1] * 
  sin(deg2rad(360-270-schreck_orientation$ausrichtung_min[1]))
schreck_orientation$ausrichung_maxE = schreck_orientation$E[1] + schreck_orientation$length[1] * 
  cos(deg2rad(360-270-schreck_orientation$ausrichtung_max[1]))
schreck_orientation$ausrichung_maxN = schreck_orientation$N[1] + schreck_orientation$length[1] * 
  sin(deg2rad(360-270-schreck_orientation$ausrichtung_max[1]))


x_coord <- c(schreck_orientation$E[1],  schreck_orientation$ausrichung_minE[1],
             schreck_orientation$ausrichung_meanE[1],
             schreck_orientation$ausrichung_maxE[1], schreck_orientation$E[1])
y_coord <- c(schreck_orientation$N[1], schreck_orientation$ausrichung_minN[1],
             schreck_orientation$ausrichung_meanN[1],
             schreck_orientation$ausrichung_maxN[1], schreck_orientation$N[1])
#p = Polygon(cbind(x_coord, y_coord))
#ps = Polygons(list(p),1)
#sps = SpatialPolygons(list(ps))
#plot(sps)
#schreck_orientation$polygon[1] = sps[1]
poly <- st_polygon(list(matrix(c(x_coord, y_coord),ncol=2, byrow=FALSE))) #%>% st_geometry(poly) %>% st_set_crs(2056)
pos <- data.frame(x=x_coord, y=y_coord, id=c(1,2,3,4,5))
#schreck_orientation$polygon <- poly 
                                                                        

ggplot() +
  geom_path(data=wildboar_closeup, aes(x=E, y=N, color=triptime0)) +
  geom_point(data = s1, aes(x=E, y=N), colour="black", size=2) +
  geom_point(data = schreck_orientation, aes(x=ausrichung_meanE, y=ausrichung_meanN), 
             colour="brown", size=2) +
  geom_polygon(data=pos, aes(x=x, y = y, fill="orange", alpha=0.4))
```

# Wilddboar scare effect properties
```{r, warning=FALSE}
# Get all trips
trips <- w %>% filter(!is.na(tripIDnight)) %>% group_by(tripIDnight)
trips 

wildboar_trip_scared <- data.frame(matrix(ncol = 21, nrow = 0))
x <- c("id", "triptime0", "approachingRate", "approachingRateRelative",
       "approachingRateAbsolute", "speed", "sinousity", "linedist", "acceleration", "speedDiff3", 
       "dist","E", "N","x", "y", "directionRelative",
       "closest_schreck", "tripIDnight", "DatetimeUTC", "hour", "day")
colnames(wildboar_trip_scared) <- x
unique(trips$tripIDnight)

for (u in 1:length(unique(trips$tripIDnight)))
{
  wildboar_trip <- trips %>% filter(tripIDnight==unique(trips$tripIDnight)[u])
  
  # Only take full trips
  if (length(wildboar_trip$TierID) > 61)
  {
    # Get wildboard schreck assosiated to wild boar
    schreck <- schreck_locations_ch %>%  filter(id == max(wildboar_trip$closest_schreck))
    # Calculate distance and time differences
    wildboar_trip <- wildboar_trip %>% 
      mutate(dist = sqrt((first(schreck$N)-N)^2+(first(schreck$E)-E)^2),
        triptime0 = as.numeric((DatetimeUTC - min(DatetimeUTC))) / 60,
        triptimeDiff = (triptime0-lag(triptime0))*60,
        distanceAbsolute = ((E- lag(E))^2 + (N-lag(N))^2)^0.5) %>% arrange(.,triptime0)
    
    # Calculate approaching rate
    wildboar_trip <- wildboar_trip %>%  
      mutate(approachingRate = lag(dist)-dist,
             approachingRateAbsolute = approachingRate / (triptimeDiff),
             approachingRateRelative = approachingRate / (distanceAbsolute),
             approachingRateRelative = ifelse(is.na(approachingRateRelative), 0, approachingRateRelative))
    # Calculate speed & acceleration
    wildboar_trip <- wildboar_trip %>%
      mutate(speed = round(distanceAbsolute / triptimeDiff, 4),
             acceleration = round((lead(speed)-speed)  * 60 / lead(triptimeDiff), 4),
             speedDiff3 = round(((speed+lead(speed)+lead(speed, 2))/3 - 
                                      (lag(speed)+lag(speed, 2)+lag(speed, 3)/3)), 4))

    # Relative coordinates (trajectory)
    wildboar_trip <- wildboar_trip %>% mutate(x=E-first(s1$E), y=N-first(s1$N))
    coords <- data.frame(x = wildboar_trip$x, 
                         y = wildboar_trip$y, 
                         times = wildboar_trip$triptime0)
    # Set all sinousitiy to 0
    wildboar_trip$sinousity = replicate(length(coords$x), NA)
    for (i in 1:(length(coords$x)-3)) {
      # Create a trajectory from the coordinates
      trj <- TrajFromCoords(coords[(i):(i+3),])
      # Rescale stepsize
      trj_re <- TrajRediscretize(trj, 1)
      # Calculate sinousity
      wildboar_trip$sinousity[i] = TrajSinuosity(trj_re, compass.direction = TRUE) %>% 
        round(digits = 4)
    }
    
    # Get proximity of movement
    wildboar_trip <- wildboar_trip %>%
     mutate(linedist = ((x^2+y^2)^0.5 + ((x-lag(x))^2+(y-lag(y))^2)^0.5)/2)
    # Get relative direction to scare device
    wildboar_trip <- wildboar_trip %>% mutate(directionRelative=
                                                ifelse(abs(x) > abs(y),
                                                       ifelse(x>0, "E", "W"),
                                                       ifelse(y>0, "N", "S")))
    # Select
    wildboar_trip_scared <- wildboar_trip_scared %>% 
      rbind(wildboar_trip %>% 
              dplyr::select(id, triptime0, approachingRate, approachingRateRelative,
                            approachingRateAbsolute, speed, sinousity, linedist, acceleration, 
                            speedDiff3, dist, E, N, x, y, directionRelative, closest_schreck, tripIDnight, 
                            DatetimeUTC, hour, day))
  }
}
head(wildboar_trip_scared)
# Scaled values
wildboar_trip_scared <- wildboar_trip_scared %>% group_by(tripIDnight) %>% 
  mutate(
    approachingRateRelativeS = (approachingRateRelative-min(approachingRateRelative, na.rm = TRUE)) /
      (max(approachingRateRelative, na.rm = TRUE)- min(approachingRateRelative, na.rm = TRUE)),
    accelerationS = (acceleration-min(acceleration, na.rm = TRUE))/
                     (max(acceleration, na.rm = TRUE) - min(acceleration, na.rm = TRUE)),
    sinousityS = (sinousity-min(sinousity, na.rm = TRUE))/
                     (max(sinousity, na.rm = TRUE)- min(sinousity, na.rm = TRUE)),
    distanceS = (dist-min(dist, na.rm = TRUE)) / (max(dist, na.rm = TRUE) - min(dist, na.rm = TRUE)),
    speedDiff3S = (speedDiff3-min(speedDiff3, na.rm=TRUE)) / 
      (max(speedDiff3, na.rm=TRUE)-min(speedDiff3, na.rm = TRUE)),
    approachingRateRelativeSlead = lead(approachingRateRelativeS),
    scareEffect = accelerationS - sinousityS - distanceS - lead(approachingRateRelativeS) + speedDiff3S,
    scary= scareEffect > 1.3,
    scary= ifelse(is.na(scary), FALSE, scary),
    scary= ifelse(scary&lag(scary), FALSE, scary)) %>% 
  ungroup()

# Get scared points
wildboar_scared <- wildboar_trip_scared %>% filter(scary)

# Get scared trips
wildboar_trip_scared_True <- wildboar_trip_scared %>% 
  group_by(tripIDnight) %>% 
  mutate(tripScared = sum(scary, na.rm = TRUE)) %>% 
  filter(tripScared > 0)

# Join trips with scared wildboars
w <- w %>% left_join(wildboar_trip_scared_True %>% 
                       dplyr::select(id, scareEffect, triptime0, accelerationS,
                                     approachingRateRelativeSlead, speedDiff3S, sinousityS,
                                     distanceS, x, y, scary), by="id")
```

# Plot all found shrecks
```{r, warning=FALSE}
# Amount of scared trips
unique(wildboar_trip_scared$tripIDnight)
unique(wildboar_trip_scared_True$tripIDnight)

for (u in 1:length(unique(wildboar_trip_scared_True$tripIDnight))) 
{
  test <- wildboar_trip_scared_True %>% filter(tripIDnight==unique(wildboar_trip_scared_True$tripIDnight)[u])
  print(first(test$DatetimeUTC))
  print(first(test$tripIDnight))
  print(ggplot(data=test) + 
    geom_vline(xintercept = (test %>% filter(scary) %>% select(triptime0))$triptime0[1]/60, color="brown") +
    geom_line( aes(x=triptime0/60, y=distanceS, alpha=0.8), color="blue") +
    geom_line( aes(x=triptime0/60, y=approachingRateRelativeS, alpha=0.8), color="green") +
    geom_line( aes(x=triptime0/60, y=accelerationS, alpha=0.8), color="orange") +
    geom_line( aes(x=triptime0/60, y=speedDiff3S, alpha=0.8), color="red") +
    geom_line( aes(x=triptime0/60, y=sinousityS, alpha=0.8), color="purple") +
    geom_line(aes(x=triptime0/60, y= scareEffect, alpha=0.8), color="black")) + 
    ggtitle(paste("Wildboar trip", first(test$tripIDnight), "started at", first(test$DatetimeUTC))) +
    xlab("Hour passed by from 18:00 p.m.") + ylab("Scaled variables (0 to 1) and scare effect (-3 to 2)")
  
    testClose <- test %>% 
      filter(scary | lead(scary) | lead(scary,2)| lead(scary,3)| lead(scary,4) | lag(scary,1)| lag(scary,2)| lag(scary,3)| lag(scary,4))
  print(first(test$DatetimeUTC))
  print(first(test$tripIDnight))
  print(ggplot(data=testClose) + 
    geom_vline(xintercept = (test %>% filter(scary) %>% select(triptime0))$triptime0[1]/60, color="brown") +
    geom_line( aes(x=triptime0/60, y=distanceS, alpha=0.8), color="blue") +
    geom_line( aes(x=triptime0/60, y=approachingRateRelativeS, alpha=0.8), color="green") +
    geom_line( aes(x=triptime0/60, y=accelerationS, alpha=0.8), color="orange") +
    geom_line( aes(x=triptime0/60, y=speedDiff3S, alpha=0.8), color="red") +
    geom_line( aes(x=triptime0/60, y=sinousityS, alpha=0.8), color="purple") +
    geom_line(aes(x=triptime0/60, y= scareEffect, alpha=0.8), color="black")) + 
    ggtitle(paste("Wildboar trip", first(testClose$tripIDnight), "1 hour before and after scare effect at",
                  testClose$DatetimeUTC[5]) +
    xlab("Hour passed by from 18:00 p.m.") + ylab("Scaled variables (0 to 1) and scare effect (-3 to 2)")
  
  print(ggplot() +
    geom_path(data= test, aes(x=E, y=N, color=triptime0)) +
    geom_point(data = schreck_locations_ch %>% filter(id == max(test$closest_schreck)), 
               aes(x=E, y=N), colour="black", size=2) +
    geom_point(data = test %>% filter(scary), aes(x=E, y=N), color="red"))
}
```

# Plot all found shrecks
```{r}
wildboar_scared_schreck <- wildboar_scared %>% left_join(schreck_locations_ch, by=c("closest_schreck"="id")) 

wildboar_scared_schreck <- wildboar_scared_schreck %>% 
  select(ausrichtung_dir, directionRelative, dist, lautstaerke, scareEffect) %>% 
  mutate(sameDirection=ausrichtung_dir==directionRelative,
         #soundDistance=lautstaerke/dist,
         #schreckProbabily= soundDistance*(1+sameDirection)/ (50/50*2) * 100,
         volumeDir = ifelse(sameDirection, lautstaerke, 
                           ifelse(ausrichtung_dir=='S'&directionRelative=='N' | 
                                    ausrichtung_dir=='N'& directionRelative=='S' | 
                                    ausrichtung_dir=='W'& directionRelative=='E'| 
                                    ausrichtung_dir=='E'& directionRelative=='W', 
                                  0.5*lautstaerke, 0.75*lautstaerke)),
         soundDistance = volumeDir - abs(20 * log(1/dist, 10)),
         schreckProbabily = soundDistance *100/40)
plot(wildboar_scared_schreck$scareEffect, wildboar_scared_schreck$schreckProbabily)
wildboar_scared
schreck_locations_ch
```


# How long does the scare-off effect last
```{r}
w$return <- replicate(length(w$N), "NA")
w$return <- as.character(w$return)
w$return_hrs <- NA

for(j in 1:nrow(trip_list)){
  w$return <- as.character(w$return)
  w$return_hrs <- as.numeric(as.character(w$return_hrs))
  under400 <- w[w$TierName==trip_list$TierName[j] & w$DatetimeUTC>trip_list$DatetimeUTC[j] + 4*60*60 & w$closest_schreck==trip_list$closest_schreck[j] & !is.na(w$distance_to_closest_schreck),]  
  
under400 <- under400[order(under400$DatetimeUTC),]
 if(nrow(under400)==0){w[w$tripIDnight==trip_list$tripIDnight[j] & !is.na(w$tripIDnight),]$return <- "never"
 w[w$tripIDnight==trip_list$tripIDnight[j] & !is.na(w$tripIDnight), "return_hrs"] <- NA
 } else{
   w[w$tripIDnight==trip_list$tripIDnight[j] & !is.na(w$tripIDnight), "return"] <- as.character(under400[1,]$DatetimeUTC) 
   w$return <- as.POSIXct(w$return, format="%Y-%m-%d %H:%M:%S",tz="UTC")
   return_time <- as.numeric(as.character(difftime(under400[1,]$DatetimeUTC,trip_list[j,]$DatetimeUTC, units="hours")))
   w[w$tripIDnight==trip_list$tripIDnight[j] & !is.na(w$tripIDnight),"return_hrs"] <- return_time
 }}
   
w$return_hrs <- round(w$return_hrs,digits = 2)



```

# Adding Crop Field
```{r}
crop <- read_sf("Feldaufnahmen_Fanel.gpkg")